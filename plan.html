<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plan Your Journey ‚Äî GENESIS</title>

  <!-- Theme + Fonts -->
  <link rel="stylesheet" href="css/genesis-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet (OpenStreetMap) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body {
      margin: 0; padding: 0;
      background: linear-gradient(120deg, var(--bg1), var(--bg2));
      color: var(--text);
      height: 100%;
      overflow-x: hidden;
      font-family: 'Poppins', sans-serif;
    }

    .app { max-width: 480px; margin: auto; }

    .menu-btn {
      border: 0; background: none; font-size: 20px; cursor: pointer;
    }

    .brand {
      font-weight: 700; font-size: 20px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .points {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: #00251f; padding: 6px 10px; border-radius: 20px; font-weight: 600;
    }

    .profile {
      width: 38px; height: 38px; border-radius: 50%;
      background: url('https://cdn-icons-png.flaticon.com/512/3135/3135715.png') center/cover;
      border: 2px solid var(--accent);
    }

    .sidebar {
      position: fixed; top: 0; left: -260px;
      width: 240px; height: 100vh;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
      transition: .4s; z-index: 50; padding-top: 80px;
    }

    .sidebar.open { left: 0; }

    .sidebar a {
      display: block; padding: 14px 20px;
      color: var(--text); font-weight: 600;
      text-decoration: none;
    }

    .sidebar a:hover { background: rgba(0, 191, 166, 0.15); }

    .close-btn {
      position: absolute; top: 20px; right: 20px;
      border: none; background: none; font-size: 18px; cursor: pointer;
    }

    h2 {
      text-align: center; margin-top: 20px; color: var(--primary);
    }

    .form {
      margin: 16px 16px 10px; padding: 16px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    label {
      font-weight: 600; font-size: 14px; color: var(--text);
    }

    input[type="text"], select {
      width: 100%;
      padding: 12px;
      margin: 8px 0 14px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 10px;
      font-family: inherit;
      font-size: 14px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(6px);
    }

    button {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      color: #00251f;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: .3s;
      position: relative;
    }

    button:hover { opacity: 0.9; transform: scale(1.02); }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .secondary-btn {
      background: white;
      border: 1px dashed var(--primary);
      color: var(--primary);
      margin-bottom: 10px;
    }

    .loader {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-left: 8px;
    }

    button.loading .loader {
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .map-wrapper {
      margin: 0 16px 18px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 260px;
    }

    .map-hint {
      font-size: 12px;
      color: var(--muted);
      padding: 8px 12px 12px;
    }

    .tip {
      background: linear-gradient(120deg,#d8ffe9,#f0fff6);
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 13px;
      margin: 0 16px 18px;
      color: #045b48;
      box-shadow: var(--shadow);
      text-align: center;
      animation: fadeIn 2s ease-in-out;
    }

    .error-msg {
      background: linear-gradient(120deg, #ffe9e9, #fff5f5);
      color: #c41e3a;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 12px;
      margin: 0 16px 12px;
      display: none;
    }

    .error-msg.show {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .footer {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      padding: 30px;
    }

    @media (max-width: 480px) {
      .form { margin: 12px; padding: 14px; }
      .map-wrapper { margin: 0 12px 16px; }
      h2 { font-size: 1.3em; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Navbar -->
    <div class="nav">
      <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <div class="brand">GENESIS</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="points" id="pointsDisplay">üå± 0 pts</div>
        <div class="profile"></div>
      </div>
    </div>

    <!-- Sidebar (clean, premium) -->
    <div class="sidebar" id="sidebar">
      <button class="close-btn" onclick="toggleSidebar()">‚úï</button>
      <a href="index.html">üè† Home</a>
      <a href="plan.html">üß≠ Plan Journey</a>
      <a href="report.html">üö® Report</a>
      <a href="impact.html">üìä Impact</a>
      <a href="rewards.html">üéÅ Rewards</a>
      <a href="leaderboard.html">üèÜ Leaderboard</a>
      <a href="admin.html">üîí Admin</a>
      <a href="about.html">‚ÑπÔ∏è About</a>
    </div>

    <!-- Title -->
    <h2>Plan Your Journey</h2>

    <!-- Error Message -->
    <div class="error-msg" id="errorMsg"></div>

    <!-- Journey Form -->
    <div class="form">
      <label>From:</label>
      <input type="text" id="from" placeholder="Enter starting point (e.g., Velachery)" />

      <button class="secondary-btn" type="button" id="locationBtn" onclick="useCurrentLocation()">
        üìç Use my current location
        <span class="loader"></span>
      </button>

      <label>To:</label>
      <input type="text" id="to" placeholder="Enter destination (e.g., T. Nagar)" />

      <label>Priority:</label>
      <select id="priority">
        <option value="balanced">üåø Balanced (AI Recommended)</option>
        <option value="fastest">üöÄ Fastest Route</option>
        <option value="safest">üõ°Ô∏è Safest Route</option>
        <option value="greenest">üå± Greenest Route</option>
      </select>

      <button type="button" id="planBtn" onclick="planJourney()">
        üîç Plan My Journey
        <span class="loader"></span>
      </button>
    </div>

    <!-- Map (OpenStreetMap via Leaflet) -->
    <div class="map-wrapper">
      <div id="map"></div>
      <div class="map-hint">
        üó∫Ô∏è Tip: Tap on the map to set your <b>destination</b>. We'll snap it to the nearest place in Chennai.
      </div>
    </div>

    <div class="tip" id="aiTip">
      üí° AI Insight: Traffic on Mount Road is heavy ‚Äî try Metro for faster travel üå±
    </div>

    <div class="footer">
      ¬© 2025 GENESIS ‚Äî Smart, Safe, Sustainable Transit üíö
    </div>
  </div>

  <script>
    // Sidebar toggle
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Fallback points from localStorage (auth.js may override with real Firestore value)
    let fallbackPoints = parseInt(localStorage.getItem("genesis_points") || 420);
    const pointsEl = document.getElementById("pointsDisplay");
    if (pointsEl) {
      pointsEl.innerText = "üå± " + fallbackPoints + " pts";
    }

    // ---------- ERROR HANDLING ----------
    function showError(message) {
      const errorEl = document.getElementById("errorMsg");
      errorEl.textContent = message;
      errorEl.classList.add("show");
      setTimeout(() => {
        errorEl.classList.remove("show");
      }, 5000);
    }

    // ---------- LEAFLET MAP SETUP ----------
    let map, fromMarker, toMarker, routeLine;
    let fromCoords = null;
    let toCoords = null;
    let lastGeocodingTime = 0;
    const GEOCODING_DELAY = 1000; // 1 second delay between API calls

    // Custom marker icons
    const fromIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxMiIgZmlsbD0iIzAwYmZhNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    const toIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxMiIgZmlsbD0iI2ZmNTcyMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    function initMap() {
      // Center on Chennai
      map = L.map('map').setView([13.0827, 80.2707], 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Click on map to set destination
      map.on('click', async (e) => {
        toCoords = {
          lat: e.latlng.lat,
          lng: e.latlng.lng
        };

        if (toMarker) map.removeLayer(toMarker);
        toMarker = L.marker([toCoords.lat, toCoords.lng], {icon: toIcon}).addTo(map);

        // Reverse geocode to get a name (with rate limiting)
        const name = await reverseGeocode(toCoords.lat, toCoords.lng);
        const toInput = document.getElementById("to");
        toInput.value = name || `Pinned: ${toCoords.lat.toFixed(4)}, ${toCoords.lng.toFixed(4)}`;

        // Draw line if both points exist
        updateRouteLine();
      });

      // If previous journey exists, preload
      const prevFrom = localStorage.getItem("journey_from");
      const prevTo = localStorage.getItem("journey_to");
      if (prevFrom) document.getElementById("from").value = prevFrom;
      if (prevTo) document.getElementById("to").value = prevTo;
    }

    // Update visual route line on map
    function updateRouteLine() {
      if (routeLine) map.removeLayer(routeLine);
      if (fromCoords && toCoords) {
        routeLine = L.polyline([
          [fromCoords.lat, fromCoords.lng],
          [toCoords.lat, toCoords.lng]
        ], {
          color: '#00bfa6',
          weight: 3,
          opacity: 0.7,
          dashArray: '10, 10'
        }).addTo(map);

        // Fit map to show both markers
        const bounds = L.latLngBounds(
          [fromCoords.lat, fromCoords.lng],
          [toCoords.lat, toCoords.lng]
        );
        map.fitBounds(bounds, {padding: [50, 50]});
      }
    }

    // Reset coordinates when user types
    document.getElementById("from").addEventListener("input", () => {
      fromCoords = null;
      if (fromMarker) {
        map.removeLayer(fromMarker);
        fromMarker = null;
      }
      if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
      }
    });

    document.getElementById("to").addEventListener("input", () => {
      toCoords = null;
      if (toMarker) {
        map.removeLayer(toMarker);
        toMarker = null;
      }
      if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
      }
    });

    // ---------- GEOLOCATION ----------
    async function useCurrentLocation() {
      if (!navigator.geolocation) {
        showError("Geolocation not supported on this device.");
        return;
      }

      const btn = document.getElementById("locationBtn");
      btn.classList.add("loading");
      btn.disabled = true;

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        fromCoords = { lat, lng };

        if (fromMarker) map.removeLayer(fromMarker);
        fromMarker = L.marker([lat, lng], {icon: fromIcon}).addTo(map);

        map.setView([lat, lng], 14);

        const name = await reverseGeocode(lat, lng);
        document.getElementById("from").value = name || `My location (${lat.toFixed(4)}, ${lng.toFixed(4)})`;

        btn.classList.remove("loading");
        btn.disabled = false;

        updateRouteLine();

      }, (err) => {
        console.error(err);
        showError("Unable to fetch your location. Please check permissions.");
        btn.classList.remove("loading");
        btn.disabled = false;
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    // ---------- RATE LIMITED API CALLS ----------
    async function waitForRateLimit() {
      const now = Date.now();
      const timeSinceLastCall = now - lastGeocodingTime;
      if (timeSinceLastCall < GEOCODING_DELAY) {
        await new Promise(resolve => setTimeout(resolve, GEOCODING_DELAY - timeSinceLastCall));
      }
      lastGeocodingTime = Date.now();
    }

    // ---------- GEOCODING HELPERS (OpenStreetMap Nominatim) ----------
    async function geocodePlace(query) {
      if (!query) return null;
      
      await waitForRateLimit();
      
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(query + ", Chennai, Tamil Nadu, India")}&limit=1`;
      try {
        const res = await fetch(url, {
          headers: {
            "Accept": "application/json",
            "User-Agent": "GENESIS-Transit-App/1.0"
          }
        });
        
        if (!res.ok) {
          throw new Error(`Geocoding failed: ${res.status}`);
        }
        
        const data = await res.json();
        if (!data || !data.length) return null;
        const best = data[0];
        return {
          name: best.display_name,
          lat: parseFloat(best.lat),
          lng: parseFloat(best.lon)
        };
      } catch (e) {
        console.error("Geocoding error:", e);
        showError("Location search temporarily unavailable. Try again in a moment.");
        return null;
      }
    }

    async function reverseGeocode(lat, lng) {
      await waitForRateLimit();
      
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      try {
        const res = await fetch(url, {
          headers: {
            "Accept": "application/json",
            "User-Agent": "GENESIS-Transit-App/1.0"
          }
        });
        
        if (!res.ok) {
          throw new Error(`Reverse geocoding failed: ${res.status}`);
        }
        
        const data = await res.json();
        
        // Extract a shorter, more readable name
        const address = data.address || {};
        const shortName = address.road || address.suburb || address.neighbourhood || address.city_district || data.display_name;
        
        return shortName || data.display_name || null;
      } catch (e) {
        console.error("Reverse geocode error:", e);
        return null;
      }
    }

    // ---------- PLAN JOURNEY ----------
    async function planJourney() {
      const fromInput = document.getElementById('from').value.trim();
      const toInput = document.getElementById('to').value.trim();
      const priority = document.getElementById('priority').value;

      if (!fromInput || !toInput) {
        showError("Please enter both starting point and destination.");
        return;
      }

      const btn = document.getElementById("planBtn");
      btn.classList.add("loading");
      btn.disabled = true;

      try {
        // If coords not set yet, geocode them
        if (!fromCoords) {
          const geoFrom = await geocodePlace(fromInput);
          if (!geoFrom) {
            showError("Could not locate your starting point. Please try a different location or use the map.");
            btn.classList.remove("loading");
            btn.disabled = false;
            return;
          }
          fromCoords = geoFrom;
          
          // Add marker
          if (fromMarker) map.removeLayer(fromMarker);
          fromMarker = L.marker([fromCoords.lat, fromCoords.lng], {icon: fromIcon}).addTo(map);
        }

        if (!toCoords) {
          const geoTo = await geocodePlace(toInput);
          if (!geoTo) {
            showError("Could not locate your destination. Please try a different location or use the map.");
            btn.classList.remove("loading");
            btn.disabled = false;
            return;
          }
          toCoords = geoTo;
          
          // Add marker
          if (toMarker) map.removeLayer(toMarker);
          toMarker = L.marker([toCoords.lat, toCoords.lng], {icon: toIcon}).addTo(map);
        }

        // Update visual route
        updateRouteLine();

        // Save to localStorage so compare.html can read them
        localStorage.setItem("journey_from", fromInput);
        localStorage.setItem("journey_to", toInput);
        localStorage.setItem("journey_priority", priority);

        localStorage.setItem("journey_from_lat", fromCoords.lat);
        localStorage.setItem("journey_from_lng", fromCoords.lng);
        localStorage.setItem("journey_to_lat", toCoords.lat);
        localStorage.setItem("journey_to_lng", toCoords.lng);

        // Small delay to show the route before redirect
        await new Promise(resolve => setTimeout(resolve, 800));

        // Redirect to Compare Page
        window.location.href = "compare.html";
        
      } catch (error) {
        console.error("Journey planning error:", error);
        showError("Something went wrong. Please try again.");
        btn.classList.remove("loading");
        btn.disabled = false;
      }
    }

    // ---------- AI Insight rotation ----------
    const tips = [
      "üí° Avoid T. Nagar between 5‚Äì7 PM ‚Äî high crowd density expected.",
      "üå± Try combining Metro + Walk to save ~1.1 kg CO‚ÇÇ today!",
      "üö¥ Chennai is sunny ‚Äî good time for a cycle ride!",
      "üíö AI recommends safer route via Guindy Metro Station."
    ];

    let tipIndex = 0;
    setInterval(() => {
      const tipEl = document.getElementById("aiTip");
      if (!tipEl) return;
      tipEl.innerHTML = tips[tipIndex];
      tipIndex = (tipIndex + 1) % tips.length;
    }, 6000);

    // Init map once DOM loads
    window.addEventListener("load", initMap);
  </script>

  <!-- Firebase CDN (Compat builds) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Your Firebase init + auth logic -->
  <script src="js/firebase-init.js"></script>
  <script src="js/auth.js"></script>
</body>
</html>
