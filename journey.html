<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Journey ‚Äî GENESIS</title>

<link rel="stylesheet" href="css/genesis-theme.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style> 
  /* üåø GENESIS THEME STYLESHEET */
/* Common across all pages */

/* 1Ô∏è‚É£ Root Variables */
:root {
  --primary: #00bfa6;
  --accent: #63ff9c;
  --bg1: #e8fff6;
  --bg2: #ffffff;
  --text: #0a3227;
  --muted: #5a7c71;
  --card: rgba(255, 255, 255, 0.95);
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --font-main: 'Poppins', sans-serif;
}

/* 2Ô∏è‚É£ Global Styles */
html, body {
  margin: 0;
  padding: 0;
  font-family: var(--font-main);
  color: var(--text);
  background: linear-gradient(120deg, var(--bg1), var(--bg2));
  overflow-x: hidden;
  scroll-behavior: smooth;
}

/* 3Ô∏è‚É£ App Wrapper */
.app {
  max-width: 1000px;
  margin: auto;
  position: relative;
}

/* 4Ô∏è‚É£ Navbar */
.nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 20px;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 100;
}
.brand {
  font-weight: 700;
  font-size: 22px;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.menu-btn {
  border: 0;
  background: none;
  font-size: 22px;
  cursor: pointer;
  color: var(--primary);
}
.points {
  background: linear-gradient(90deg, var(--primary), var(--accent));
  color: #00251f;
  padding: 6px 10px;
  border-radius: 20px;
  font-weight: 600;
}
.profile {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: url('https://cdn-icons-png.flaticon.com/512/3135/3135715.png') center/cover;
  border: 2px solid var(--accent);
}

/* 5Ô∏è‚É£ Sidebar */
.sidebar {
  position: fixed;
  top: 0;
  left: -260px;
  width: 240px;
  height: 100vh;
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(12px);
  box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
  transition: 0.4s;
  z-index: 200;
  padding-top: 80px;
}
.sidebar.open { left: 0; }
.sidebar a {
  display: block;
  padding: 14px 20px;
  color: var(--text);
  font-weight: 600;
  text-decoration: none;
}
.sidebar a:hover {
  background: rgba(0, 191, 166, 0.15);
}
.close-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  border: none;
  background: none;
  font-size: 18px;
  cursor: pointer;
}

/* 6Ô∏è‚É£ Buttons */
button {
  background: linear-gradient(90deg, var(--primary), var(--accent));
  border: none;
  padding: 12px 16px;
  border-radius: 10px;
  color: #00251f;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}
button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

/* 7Ô∏è‚É£ Cards */
.card {
  background: var(--card);
  padding: 18px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  margin: 10px 0;
  transition: 0.3s;
}
.card:hover {
  transform: translateY(-4px);
}
.card h3 {
  margin: 0;
  color: var(--primary);
}

/* 8Ô∏è‚É£ Inputs & Forms */
input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 10px;
  font-family: var(--font-main);
  font-size: 14px;
  margin-bottom: 12px;
}
textarea {
  resize: none;
  height: 80px;
}

/* 9Ô∏è‚É£ Animations */
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
@keyframes glowPulse {
  0% { box-shadow: 0 0 10px rgba(0,191,166,0.3); }
  50% { box-shadow: 0 0 25px rgba(0,191,166,0.6); }
  100% { box-shadow: 0 0 10px rgba(0,191,166,0.3); }
}
.glow { animation: glowPulse 2.5s infinite; }

/* üîü Sections & Headings */
section {
  padding: 30px 20px;
}
h2 {
  text-align: center;
  color: var(--primary);
  margin-top: 20px;
}
h3 {
  color: var(--primary);
}
p {
  color: var(--muted);
  line-height: 1.6;
  font-size: 15px;
}

/* ü™© Utility Classes */
.text-center { text-align: center; }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 24px; }
.fade-in {
  animation: fadeIn 1s ease forwards;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* üì± Responsive */
@media(max-width:768px){
  .nav { padding: 12px; }
  .brand { font-size: 18px; }
  .sidebar { width: 220px; }
  section { padding: 20px 16px; }
}

/* üåç Footer */
.footer {
  text-align: center;
  font-size: 12px;
  color: var(--muted);
  padding: 30px;
}
  body {
    background: #f7f7f7;
    font-family: 'Poppins', sans-serif;
  }

  .nav {
    background: #ffffffcc;
    backdrop-filter: blur(10px);
  }

  #map {
    width: 100%;
    height: 260px;
    border-radius: 16px;
    margin: 12px 0;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
  }

  .journey-card {
    background: white;
    margin: 16px;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: #e5e5e5;
    border-radius: 20px;
    margin-top: 8px;
  }
  .progress {
    height: 8px;
    background: var(--primary);
    width: 0%;
    border-radius: 20px;
  }

  .ai-box {
    background: white;
    padding: 14px;
    border-radius: 14px;
    margin: 16px;
    text-align: center;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    font-size: 13px;
    color: #045b48;
  }

  button.small {
    padding: 10px 12px;
    margin-top: 10px;
    width: 48%;
  }
</style>
</head>

<body>
<div class="app">

  <!-- NAV -->
  <div class="nav">
    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="brand">GENESIS</div>
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="points" id="pointsDisplay">üå± 0 pts</div>
      <div class="profile"></div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <button class="close-btn" onclick="toggleSidebar()">‚úï</button>
    <a href="index.html">üè† Home</a>
    <a href="plan.html">üß≠ Plan Journey</a>
    <a href="compare.html">üó∫Ô∏è Compare</a>
    <a href="journey.html">‚ñ∂Ô∏è Journey</a>
    <a href="report.html">üö® Report</a>
    <a href="impact.html">üìä Impact</a>
    <a href="rewards.html">üéÅ Rewards</a>
    <a href="leaderboard.html">üèÜ Leaderboard</a>
    <a href="admin.html">üîí Admin</a>
    <a href="about.html">‚ÑπÔ∏è About</a>
  </div>

  <h2 style="text-align:center;color:var(--primary);margin-top:15px;">Journey In Progress</h2>

  <!-- MAP -->
  <div id="map"></div>

  <!-- JOURNEY CARD -->
  <div class="journey-card">
    <h3 style="margin-top:0;">Live Stats</h3>
    <p><b>Mode:</b> <span id="modeLabel">Auto-detecting...</span></p>
    <p><b>ETA:</b> <span id="eta">--</span></p>
    <p><b>Distance Left:</b> <span id="remaining">--</span></p>

    <div class="progress-bar"><div class="progress" id="progress"></div></div>

    <p style="margin-top:14px;">
      <b>CO‚ÇÇ Saved:</b> <span id="co2Saved">0.00</span> kg<br>
      <b>GreenPoints:</b> <span id="pointsEarned">0</span> pts
    </p>

    <button class="small" onclick="pauseJourney()">‚è∏ Pause</button>
    <button class="small" onclick="endJourney()">‚èπ End</button>
  </div>

  <!-- AI INSIGHTS -->
  <div class="ai-box" id="aiTip">Analyzing live situation...</div>

  <!-- GUARDIAN MODE -->
  <div class="journey-card">
    <h3>üõ°Ô∏è Guardian Mode</h3>
    <input type="tel" id="guardianNum" placeholder="Guardian phone (+91...)">
    <button class="small" onclick="enableGuardian()">Enable</button>
    <button class="small" onclick="sendSOS()">üö® SOS</button>
  </div>

  <div class="footer">¬© 2025 GENESIS ‚Äî Travel Smart üíö</div>

</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- CSV Parser -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<!-- Firebase Compat -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script src="js/firebase-init.js"></script>
<script src="js/auth.js"></script>

<script>
/* ---------------------------------------------
   SIDEBAR
--------------------------------------------- */
function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("open");
}

/* ---------------------------------------------
   FIREBASE POINTS LOAD
--------------------------------------------- */
firebase.auth().onAuthStateChanged(async user => {
  if (!user) return;
  const db = firebase.firestore();
  const snap = await db.collection("users").doc(user.uid).get();
  document.getElementById("pointsDisplay").innerText = "üå± " + (snap.data().points || 0) + " pts";
});

/* -------------------------------------------------
   MAP + ROUTING
-------------------------------------------------- */
let map = L.map("map");
let routeLine;
let userMarker;

let from = localStorage.getItem("journey_from");
let to   = localStorage.getItem("journey_to");
let routeCoords = [];
let totalDistance = 0;

async function geocode(place){
  let url = `https://nominatim.openstreetmap.org/search?format=json&q=${place}`;
  let r = await fetch(url);
  let j = await r.json();
  return [parseFloat(j[0].lat), parseFloat(j[0].lon)];
}

async function getRoute(){
  let start = await geocode(from);
  let end   = await geocode(to);

  map.setView(start, 14);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  let url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?geometries=geojson&overview=full`;
  let res = await fetch(url);
  let data = await res.json();

  routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
  totalDistance = data.routes[0].distance / 1000;

  routeLine = L.polyline(routeCoords, {color:"var(--primary)", weight:5}).addTo(map);
  map.fitBounds(routeLine.getBounds());
}

getRoute();

/* -------------------------------------------------
   LIVE LOCATION + MODE DETECTION
-------------------------------------------------- */
let startTime = Date.now();
let lastPos = null;
let totalCo2 = 0;
let points = 0;

navigator.geolocation.watchPosition(pos => {
  let lat = pos.coords.latitude;
  let lon = pos.coords.longitude;

  if (!userMarker){
    userMarker = L.marker([lat, lon]).addTo(map);
  } else {
    userMarker.setLatLng([lat, lon]);
  }

  updateProgress(lat, lon);
  detectMode(pos);

}, err => console.log(err), { enableHighAccuracy:true });

function detectMode(pos){
  let speed = pos.coords.speed; // m/s
  if (!speed || speed < 1.5) {
    document.getElementById("modeLabel").innerText = "Walking";
  } else if (speed < 6) {
    document.getElementById("modeLabel").innerText = "Bike";
  } else if (speed < 18) {
    document.getElementById("modeLabel").innerText = "Car/Bus";
  } else {
    document.getElementById("modeLabel").innerText = "Metro/Train";
  }
}

/* -------------------------------------------------
   PROGRESS + ETA
-------------------------------------------------- */
function calcDistance(lat1, lon1, lat2, lon2){
  let R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  let a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function updateProgress(lat, lon){
  let minDist = Infinity;
  let closest;

  routeCoords.forEach(p=>{
    let d = calcDistance(lat, lon, p[0], p[1]);
    if (d < minDist){
      minDist = d;
      closest = p;
    }
  });

  let remainingDist = calcDistance(lat, lon, routeCoords[routeCoords.length-1][0], routeCoords[routeCoords.length-1][1]);

  let completed = ((totalDistance - remainingDist) / totalDistance) * 100;
  if (completed < 0) completed = 0;

  document.getElementById("remaining").innerText = remainingDist.toFixed(2) + " km";
  document.getElementById("progress").style.width = completed + "%";

  let elapsedMin = (Date.now() - startTime) / 60000;
  let speed = (totalDistance - remainingDist) / elapsedMin; // km/min
  let etaMin = remainingDist / (speed || 0.4);

  document.getElementById("eta").innerText = Math.ceil(etaMin) + " mins";

  totalCo2 += 0.002;
  points = Math.floor(totalCo2 * 10);

  document.getElementById("co2Saved").innerText = totalCo2.toFixed(2);
  document.getElementById("pointsEarned").innerText = points;

  updateAISuggestions(lat, lon);
}

/* -------------------------------------------------
   AI SUGGESTIONS USING SAFETY CSV
-------------------------------------------------- */
let safetyData = [];

Papa.parse("data/chennai_route_safety.csv", {
  download:true,
  header:true,
  complete: (res)=> safetyData = res.data
});

function updateAISuggestions(lat, lon){
  let nearest = null;
  let dist = Infinity;

  safetyData.forEach(loc=>{
    let d = calcDistance(lat, lon, parseFloat(loc.latitude), parseFloat(loc.longitude));
    if (d < dist){
      dist = d;
      nearest = loc;
    }
  });

  if (!nearest) return;

  let S = (0.3*(nearest.accidents_last_year/40)
        + 0.25*(nearest.crime_rate)
        + 0.25*(nearest.hazard_density)
        + 0.2*(1 - nearest.flood_risk_score)) * 100;

  let msg = "Smooth journey ahead.";

  if (S > 70) msg = "‚ö†Ô∏è High-risk zone nearby. Stay alert.";
  else if (nearest.dog_attacks_reported > 10) msg = "üêï Reports of stray dogs nearby.";
  else if (nearest.flood_risk_score > 0.6) msg = "üåßÔ∏è Minor flooding possible.";

  document.getElementById("aiTip").innerText = msg;
}

/* -------------------------------------------------
   GUARDIAN MODE
-------------------------------------------------- */
let guardian = null;

function enableGuardian(){
  guardian = document.getElementById("guardianNum").value;
  if (!guardian) return alert("Enter valid number");
  alert("Guardian Enabled: " + guardian);
}

function sendSOS(){
  if (!guardian) return alert("Enable Guardian Mode first");
  alert("üö® Dummy SOS sent to " + guardian);
}

/* -------------------------------------------------
   END JOURNEY
-------------------------------------------------- */
async function endJourney(){
  const user = firebase.auth().currentUser;
  if (!user) return;

  const db = firebase.firestore();
  let doc = await db.collection("users").doc(user.uid).get();
  let oldPoints = doc.data().points || 0;

  await db.collection("users").doc(user.uid).update({
    points: oldPoints + points
  });

  alert("Journey Completed! Earned " + points + " pts");
  window.location.href = "impact.html";
}

function pauseJourney(){
  alert("Paused (dummy)");
}
</script>

</body>
</html>

