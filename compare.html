<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Compare Routes ‚Äî GENESIS</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/genesis-theme.css">

<style>
body {
  margin:0; font-family:Poppins,sans-serif;
  background:linear-gradient(120deg,var(--bg1),var(--bg2));
  color:var(--text);
}

.app { max-width:480px; margin:auto; padding-bottom:60px; }

.nav {
  display:flex; justify-content:space-between;
  padding:14px 20px; font-weight:600;
}
.brand {
  font-size:22px;
  background: linear-gradient(90deg,var(--primary),var(--accent));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.points {
  background:white; padding:8px 16px;
  border-radius:14px; font-weight:600;
}

h2 { text-align:center; margin:20px 0; color:var(--primary); }

.route-card {
  background:white;
  margin:16px; padding:20px;
  border-radius:14px; box-shadow:var(--shadow);
  position:relative;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

.metric {
  background:#f2fff7;
  padding:10px; border-radius:10px;
  margin-top:10px;
}
.metric-label { font-size:12px; color:#777; }
.metric-value { font-size:18px; font-weight:700; }

.tag {
  display:inline-block;
  padding:6px 10px; border-radius:8px;
  background:#eafff3; margin-right:6px;
  font-size:12px; font-weight:600;
}

.dog-risk { background:#ffe4e4; color:#b60000; }

.start-btn {
  width:100%; padding:12px; border:none;
  background:linear-gradient(90deg,var(--primary),var(--accent));
  color:#00251f; font-weight:700;
  border-radius:10px; cursor:pointer;
  margin-top:14px;
}
.recommended-badge{
  background:linear-gradient(90deg,var(--primary),var(--accent));
  color:#00251f;
  padding:6px 10px; border-radius:8px;
  position:absolute; top:12px; right:12px;
  font-size:12px; font-weight:700;
}

.tip {
  background:#eafff3;
  text-align:center; padding:14px;
  margin:20px; border-radius:12px;
  box-shadow:var(--shadow);
  font-size:14px; color:#045b48;
}
</style>
</head>

<body>
<div class="app">

<div class="nav">
  <div class="brand">GENESIS</div>
  <div class="points" id="pointsDisplay"></div>
</div>

<h2>Compare Routes</h2>

<div id="routesContainer"></div>

<div class="tip" id="aiTip">AI analyzing safest and greenest paths‚Ä¶</div>

</div>

<script>
// Load points
document.getElementById("pointsDisplay").innerText =
  "üå± " + (localStorage.getItem("genesis_points") || 420) + " pts";

const fromName = localStorage.getItem("journey_from");
const toName = localStorage.getItem("journey_to");
const fromLat = parseFloat(localStorage.getItem("journey_from_lat"));
const fromLng = parseFloat(localStorage.getItem("journey_from_lng"));
const toLat = parseFloat(localStorage.getItem("journey_to_lat"));
const toLng = parseFloat(localStorage.getItem("journey_to_lng"));
const priority = localStorage.getItem("journey_priority") || "balanced";

// Load CSV
async function loadSafetyCSV(){
  const res = await fetch("../safetydata.csv");
  const text = await res.text();

  const rows = text.trim().split("\n");
  const headers = rows[0].split(",");

  let data = {};

  for(let i=1;i<rows.length;i++){
    const cols = rows[i].split(",");
    let obj={};
    headers.forEach((h,idx)=>obj[h]=cols[idx]);
    data[obj.location_name] = obj;
  }

  return data;
}

// Safety Score 0‚Äì5 ‚≠ê
function calcSafety(a){
  const T = parseFloat(a.street_lighting_score);
  const C = parseFloat(a.police_presence_score);
  const R = 1 - parseFloat(a.hazard_density);
  const I = parseFloat(a.crime_rate);

  const score = (0.3*T + 0.25*C + 0.25*R + 0.2*(1-I)) * 5;
  return score.toFixed(1); // "4.2"
}

// Distance
function dist(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return +(R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))).toFixed(1);
}

// Find REAL nearest area
function nearestArea(data, lat, lng){
  let best=null, bestD=999999;

  for(const key in data){
    const a=data[key];
    const d=dist(lat,lng,parseFloat(a.latitude),parseFloat(a.longitude));
    if(d<bestD){
      bestD=d;
      best=key;
    }
  }
  return best;
}

function ecoScore(d, safer){
  const base=(d/10)*2.5;
  return safer ? (base*0.85).toFixed(2) : base.toFixed(2);
}

function renderRoute(r, recommended){
  let box=document.createElement("div");
  box.className="route-card";

  let dogTag =
    r.dogRisk === "high"
    ? `<span class="tag dog-risk">üêï Dog Risk Zone</span>`
    : `<span class="tag">üêæ Low Dog Risk</span>`;

  let rec = recommended
    ? `<div class="recommended-badge">‚≠ê Recommended</div>`
    : "";

  box.innerHTML = `
    ${rec}
    <h3>${r.type === "safer" ? "üõ° Safer Route" : "üöÄ Fastest Route"}</h3>
    <p>via ${r.via}</p>

    ${dogTag}

    <div class="metric">
      <div class="metric-label">Distance</div>
      <div class="metric-value">${r.distance} km</div>
    </div>

    <div class="metric">
      <div class="metric-label">Time</div>
      <div class="metric-value">${r.time} min</div>
    </div>

    <div class="metric">
      <div class="metric-label">Safety Score</div>
      <div class="metric-value">‚≠ê ${r.safety}</div>
    </div>

    <div class="metric">
      <div class="metric-label">CO‚ÇÇ Emission</div>
      <div class="metric-value">${r.eco} kg</div>
    </div>

    <button class="start-btn" onclick="startJourney('${r.type}')">
      Start Journey
    </button>
  `;

  document.getElementById("routesContainer").appendChild(box);
}

function startJourney(type){
  localStorage.setItem("active_route_type", type);
  window.location.href="journey.html";
}

// MAIN
(async function(){
  const data = await loadSafetyCSV();

  const totalDist = dist(fromLat, fromLng, toLat, toLng);
  const midLat = (fromLat + toLat)/2;
  const midLng = (fromLng + toLng)/2;

  const viaFast = nearestArea(data, midLat, midLng);
  const viaSafe = nearestArea(data, fromLat + 0.01, fromLng + 0.01);

  const fastData = data[viaFast];
  const safeData = data[viaSafe];

  const fastest = {
    type:"fastest",
    via:viaFast,
    distance: totalDist,
    time: Math.round(totalDist*2.2),
    safety: calcSafety(fastData),
    eco: ecoScore(totalDist,false),
    dogRisk: fastData.dog_attacks_reported > 10 ? "high":"low"
  };

  const safer = {
    type:"safer",
    via:viaSafe,
    distance: +(totalDist*1.1).toFixed(1),
    time: Math.round(totalDist*1.1*2.5),
    safety: calcSafety(safeData),
    eco: ecoScore(totalDist*1.1,true),
    dogRisk: safeData.dog_attacks_reported > 10 ? "high":"low"
  };

  let rec="fastest";
  if(priority==="safest") rec="safer";
  else if(priority==="greenest") rec = safer.eco < fastest.eco ? "safer" : "fastest";
  else if(priority==="balanced") rec = safer.safety > fastest.safety ? "safer":"fastest";

  renderRoute(fastest, rec==="fastest");
  renderRoute(safer, rec==="safer");

  document.getElementById("aiTip").innerText =
    rec==="safer"
    ? "üí° Safer route chosen due to high safety rating."
    : "‚ö° Fastest route recommended for quickest travel.";
})();
</script>

</body>
</html>
