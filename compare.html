<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compare Routes ‚Äî GENESIS</title>

  <link rel="stylesheet" href="css/genesis-theme.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    body {
      margin: 0;
      background: linear-gradient(120deg, var(--bg1), var(--bg2));
      color: var(--text);
      font-family: 'Poppins', sans-serif;
    }

    .app { max-width: 480px; margin: auto; padding-bottom: 60px; }

    .nav {
      display: flex; justify-content: space-between;
      padding: 14px 20px; font-weight: 600;
    }
    .brand {
      font-size: 22px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .points {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      padding: 6px 10px; border-radius: 20px; font-weight: 600; color: #00251f;
    }

    h2 { text-align: center; margin-top: 20px; color: var(--primary); }

    .journey-summary, .route-card {
      background: white;
      margin: 16px; padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    .route-card:hover { transform: scale(1.02); transition: 0.2s; }

    .metric { background:#f4fef9; padding:10px; border-radius:8px; margin-top:10px; }
    .metric-label { font-size:12px; color:#777; }
    .metric-value { font-size:18px; font-weight:700; }

    .start-btn {
      width:100%; padding:12px;
      background:linear-gradient(90deg,var(--primary),var(--accent));
      border:none; color:#00251f; border-radius:10px; font-weight:700; cursor:pointer;
    }

    .recommended-badge {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color:#00251f; padding:6px 10px; border-radius:8px;
      font-size:12px; position:absolute; top:12px; right:12px; font-weight:700;
    }

    .tip {
      background: #e8fff2; margin:16px; padding:16px;
      border-radius:12px; text-align:center; color:#045b48;
      box-shadow:var(--shadow);
    }
  </style>
</head>

<body>
<div class="app">

  <div class="nav">
    <div class="brand">GENESIS</div>
    <div class="points" id="pointsDisplay"></div>
  </div>

  <h2>Compare Routes</h2>

  <div class="journey-summary" id="journeySummary">
    <h3 id="routeTitle"></h3>
    <p id="routeSubtitle"></p>
  </div>

  <div id="routesContainer"></div>

  <div class="tip" id="aiTip">AI analyzing your safest and greenest options‚Ä¶</div>

</div>
<script>
// Load points
document.getElementById("pointsDisplay").innerText =
  "üå± " + (localStorage.getItem("genesis_points") || 420) + " pts";

// Get journey data from plan.html
const fromName = localStorage.getItem("journey_from");
const toName = localStorage.getItem("journey_to");
const fromLat = parseFloat(localStorage.getItem("journey_from_lat"));
const fromLng = parseFloat(localStorage.getItem("journey_from_lng"));
const toLat = parseFloat(localStorage.getItem("journey_to_lat"));
const toLng = parseFloat(localStorage.getItem("journey_to_lng"));
const priority = localStorage.getItem("journey_priority") || "balanced";

// Show summary
document.getElementById("routeTitle").innerText = `${fromName} ‚Üí ${toName}`;
document.getElementById("routeSubtitle").innerText =
  "Priority: " + priority;

// Load CSV ‚Üí convert ‚Üí calculate safety
async function loadSafetyData() {
  const res = await fetch("safetydata.csv");
  const csv = await res.text();

  const rows = csv.trim().split("\n");
  const headers = rows[0].split(",");

  let data = {};

  // Convert CSV ‚Üí JSON object
  for (let i = 1; i < rows.length; i++) {
    const cols = rows[i].split(",");
    const obj = {};
    headers.forEach((h, idx) => (obj[h] = cols[idx]));
    data[obj.location_name] = obj;
  }

  return data;
}

// Formula: S = (0.3T + 0.25C + 0.25R + 0.2(1 ‚àí I)) √ó 100
function calculateSafetyScore(areaData) {
  const T = parseFloat(areaData.street_lighting_score);
  const C = parseFloat(areaData.police_presence_score);
  const R = 1 - parseFloat(areaData.hazard_density);
  const I = parseFloat(areaData.crime_rate);

  const S = (0.3 * T + 0.25 * C + 0.25 * R + 0.2 * (1 - I)) * 100;
  return Math.round(S);
}

// Haversine distance in KM
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;
  return +(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(1);
}

function getRandomArea(safetyData) {
  const keys = Object.keys(safetyData);
  return keys[Math.floor(Math.random() * keys.length)];
}

function ecoScore(distance, safer) {
  const base = (distance / 10) * 2.5;
  return safer ? (base * 0.85).toFixed(2) : base.toFixed(2);
}

function renderRoute(route, recommended) {
  const box = document.createElement("div");
  box.className = "route-card";
  box.style.position = "relative";

  let badge = recommended ? `<div class="recommended-badge">‚≠ê AI Recommended</div>` : "";

  box.innerHTML = `
    ${badge}
    <h3>${route.type === "safer" ? "üõ°Ô∏è Safer Route" : "üöÄ Fastest Route"}</h3>
    <p>via ${route.via}</p>

    <div class="metric">
      <div class="metric-label">Distance</div>
      <div class="metric-value">${route.distance} km</div>
    </div>

    <div class="metric">
      <div class="metric-label">ETA</div>
      <div class="metric-value">${route.time} min</div>
    </div>

    <div class="metric">
      <div class="metric-label">Safety Score</div>
      <div class="metric-value">${route.safetyScore}%</div>
    </div>

    <div class="metric">
      <div class="metric-label">CO‚ÇÇ Emission</div>
      <div class="metric-value">${route.ecoScore} kg</div>
    </div>

    <button class="start-btn" onclick='startJourney("${route.type}")'>
      Start Journey
    </button>
  `;

  document.getElementById("routesContainer").appendChild(box);
}

function startJourney(type) {
  localStorage.setItem("active_route_type", type);
  localStorage.setItem("journey_start_time", Date.now());
  window.location.href = "journey.html";
}

// MAIN
async function loadRoutes() {
  const safetyData = await loadSafetyData();

  const dist = distance(fromLat, fromLng, toLat, toLng);

  // Fastest
  const fastestVia = getRandomArea(safetyData);
  const fastest = {
    type: "fastest",
    distance: dist,
    time: Math.round(dist * 2.3),
    via: fastestVia,
    safetyScore: calculateSafetyScore(safetyData[fastestVia]),
    ecoScore: ecoScore(dist, false)
  };

  // Safer
  const saferVia = getRandomArea(safetyData);
  const safer = {
    type: "safer",
    distance: +(dist * 1.12).toFixed(1),
    time: Math.round(dist * 1.12 * 2.5),
    via: saferVia,
    safetyScore: calculateSafetyScore(safetyData[saferVia]),
    ecoScore: ecoScore(dist * 1.12, true)
  };

  // Recommended route logic
  let recommended = "fastest";
  if (priority === "safest") recommended = "safer";
  else if (priority === "greenest") recommended = safer.ecoScore < fastest.ecoScore ? "safer" : "fastest";
  else if (priority === "balanced")
    recommended = safer.safetyScore > fastest.safetyScore ? "safer" : "fastest";

  // Render
  renderRoute(fastest, recommended === "fastest");
  renderRoute(safer, recommended === "safer");

  // Tip
  document.getElementById("aiTip").innerText =
    recommended === "safer"
      ? "üí° Safer route chosen due to higher safety score."
      : "‚ö° Fastest route recommended based on ETA.";
}

loadRoutes();
</script>

</body>
</html>



